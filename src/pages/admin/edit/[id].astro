---
import MainLayout from '../../../layouts/MainLayout.astro';
import { supabase } from '../../../lib/supabase';
import { type Product } from '../../../types'; // CORRECTED PATH

const { id } = Astro.params;
let product: Product | null = null;

if (id) {
  const { data } = await supabase.from('products').select('*').eq('id', id).single();
  product = data as Product;
}
if (!product) { return new Response("Product not found", { status: 404 }); }
---
<MainLayout title={`Edit: ${product.title}`}>
  <div class="admin-panel">
    <a href="/admin" class="back-link">‚Üê Back to Admin Panel</a>
    <h1>Edit: {product.title || 'Untitled'}</h1>
    <section class="admin-section">
      <form id="edit-product-form" class="product-form"><!-- ... form contents ... --></form>
    </section>
  </div>
</MainLayout>

<script>
  const editForm = document.getElementById('edit-product-form') as HTMLFormElement;
  editForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(editForm);
    
    // CORRECTED: Create a new object for the payload
    const productData = {
      id: formData.get('id'),
      title: formData.get('title'),
      description: formData.get('description'),
      category: formData.get('category'),
      price: parseFloat(formData.get('price') as string),
      image: formData.get('image'),
      images: JSON.parse(formData.get('images') as string)
    };

    const response = await fetch('/api/products/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(productData),
    });

    if (response.ok) {
      alert('Product updated successfully!');
      window.location.href = '/admin';
    } else {
      const result = await response.json();
      alert(`Error updating product: ${result.error}`);
    }
  });
</script>
<style>
  /* ... styles are unchanged ... */
</style>