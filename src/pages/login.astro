---
import MainLayout from '../layouts/MainLayout.astro';

// If a user is already logged in, redirect them away.
if (Astro.locals.session) {
    return Astro.redirect('/');
}
---
<MainLayout title="Log In - Divinex">
  <div class="auth-container">
    <div class="auth-form-wrapper">
      <h1>Welcome Back</h1>
      <p>Log in to manage your profile.</p>
      <form id="login-form" class="auth-form">
        <label>Email <input type="email" id="email" required /></label>
        <label>Password <input type="password" id="password" required /></label>
        <button type="submit" id="submit-btn" class="btn-primary">Log In</button>
        <div id="form-message"></div>
      </form>
      <p class="auth-switch">Don't have an account? <a href="/signup">Sign Up</a></p>
    </div>
  </div>
</MainLayout>
<script>
  import { supabase } from '../lib/supabase-client';

  const form = document.getElementById('login-form') as HTMLFormElement | null;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement | null;
  const formMessage = document.getElementById('form-message') as HTMLDivElement | null;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!submitBtn || !formMessage) return;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Logging In...';
    formMessage.textContent = '';
    
    const email = (document.getElementById('email') as HTMLInputElement).value;
    const password = (document.getElementById('password') as HTMLInputElement).value;

    const { error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      formMessage.textContent = error.message;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Log In';
    } else {
      // !!! THE FIX: Use a meta refresh for a more forceful redirect !!!
      formMessage.textContent = 'Success! Redirecting...';
      setTimeout(() => {
        window.location.href = '/';
      }, 500);
    }
  });
</script>
<style>
  /* Styles are unchanged */
</style>