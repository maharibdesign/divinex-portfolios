---
import MainLayout from '../layouts/MainLayout.astro';
---
<MainLayout title="Sign Up - Divinex">
  <div class="auth-container">
    <div class="auth-form-wrapper">
      <h1>Create Your Portfolio</h1>
      <p>Join the Divinex community to showcase your work.</p>
      <form id="signup-form" class="auth-form">
        <label>Full Name <input type="text" id="full_name" required /></label>
        <label>Email <input type="email" id="email" required /></label>
        <label>Password <input type="password" id="password" minlength="6" required /></label>
        <button type="submit" id="submit-btn" class="btn-primary">Sign Up</button>
        <div id="form-message"></div>
      </form>
      <p class="auth-switch">Already have an account? <a href="/login">Log In</a></p>
    </div>
  </div>
</MainLayout>
<script>
  import { supabase } from '../lib/supabase-client';
  const form = document.getElementById('signup-form') as HTMLFormElement | null;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement | null;
  const formMessage = document.getElementById('form-message') as HTMLDivElement | null;
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!submitBtn || !formMessage) return;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating Account...';
    formMessage.textContent = '';
    
    const fullName = (document.getElementById('full_name') as HTMLInputElement).value;
    const email = (document.getElementById('email') as HTMLInputElement).value;
    const password = (document.getElementById('password') as HTMLInputElement).value;
    const { error } = await supabase.auth.signUp({ 
      email, 
      password,
      options: { 
        data: { full_name: fullName },
        // THE FIX: Tell Supabase where to go after confirmation
        emailRedirectTo: `${location.origin}/api/auth/callback`
      }
    });
    if (error) {
      formMessage.textContent = error.message;
      submitBtn.removeAttribute('disabled');
      submitBtn.textContent = 'Sign Up';
    } else {
      formMessage.textContent = 'Success! Please check your email to confirm your account (if enabled).';
    }
  });
</script>
<style>/* Unchanged */</style>