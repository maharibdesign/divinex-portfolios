---
import MainLayout from '../layouts/MainLayout.astro';
---
<MainLayout title="Sign Up - Divinex">
  <div class="auth-container">
    <div class="auth-form-wrapper">
      <h1>Create Your Portfolio</h1>
      <p>Join the Divinex community to showcase your work.</p>
      <form id="signup-form" class="auth-form">
        <label>Full Name <input type="text" id="full_name" required /></label>
        <label>Email <input type="email" id="email" required /></label>
        <label>Password <input type="password" id="password" minlength="6" required /></label>
        <button type="submit" id="submit-btn" class="btn-primary">Sign Up</button>
        <div id="form-message"></div>
      </form>
      <p class="auth-switch">Already have an account? <a href="/login">Log In</a></p>
    </div>
  </div>
</MainLayout>
<script>
  import { supabase } from '../lib/supabase-client';

  const form = document.getElementById('signup-form');
  const submitBtn = document.getElementById('submit-btn');
  const formMessage = document.getElementById('form-message');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!submitBtn || !formMessage) return;

    submitBtn.setAttribute('disabled', 'true');
    submitBtn.textContent = 'Creating Account...';
    formMessage.textContent = '';
    
    const fullName = (document.getElementById('full_name') as HTMLInputElement).value;
    const email = (document.getElementById('email') as HTMLInputElement).value;
    const password = (document.getElementById('password') as HTMLInputElement).value;

    const { data, error } = await supabase.auth.signUp({ 
      email, 
      password,
      // Pass the full_name in the options metadata
      options: { data: { full_name: fullName } }
    });

    if (error) {
      formMessage.textContent = error.message;
      submitBtn.removeAttribute('disabled');
      submitBtn.textContent = 'Sign Up';
    } else {
      // !!! THE FIX: Redirect to the login page on success !!!
      alert('Account created successfully! Please log in.');
      window.location.href = '/login';
    }
  });
</script>
<style>
  /* Styles are unchanged */
  .auth-container { display: grid; place-items: center; padding: 4rem 1rem; }
  .auth-form-wrapper { max-width: 400px; width: 100%; text-align: center; }
  .auth-form { display: flex; flex-direction: column; gap: 1rem; text-align: left; margin-top: 2rem; }
  .auth-form label { font-weight: 500; }
  .auth-form input { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); }
  .btn-primary { width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background-color: var(--button-color); color: var(--button-text-color); font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
  .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }
  #form-message { margin-top: 1rem; color: var(--hint-color); min-height: 1.2em; }
  .auth-switch { margin-top: 2rem; color: var(--hint-color); }
</style>